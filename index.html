<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro</title>


    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <!-- Dentro da seção head -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="FinControl">

    <link rel="apple-touch-icon" href="./assets/icons/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-status-bar" content="#ffffff" />
    <meta name="theme-color" content="#ffffff" />

    <!-- Integração do Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
    <script src="https://kit.fontawesome.com/eb087764b4.js" crossorigin="anonymous"></script>
    <!-- choose one -->
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <!-- Inclua o jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="./assets/js/jquery.mask.min.js"></script>
    <script src="./vendor/saveAs/dist/saveAs.js"></script>


    <!-- Inclua o jQuery UI -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>


    <script src="./vendor/ToastyKit/dist/js/toastykit.js"></script>
    <link href="./vendor/ToastyKit/dist/css/toastykit.css" rel="stylesheet">



    <!--Firebase config-->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>


    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Configuracao do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC1DegxDNN099jZjsnN2YBWZuE6u_gG16Y",
            authDomain: "fincontrol-3b9fa.firebaseapp.com",
            projectId: "fincontrol-3b9fa",
            storageBucket: "fincontrol-3b9fa.appspot.com",
            messagingSenderId: "521919064536",
            appId: "1:521919064536:web:7662b273b48cbcbdebeaad"
        };


        // inicialização
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        const auth = firebase.auth(app);
        /*
                var email = "amaral.nbr@gmail.com";
                var password = "240587";
        
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Login bem-sucedido
                        var user = userCredential.user;
                        console.log("Usuário logado:", user.uid);
        
        
                    })
                    .catch((error) => {
                        // Tratar erros de login
                        console.error("Erro ao fazer login:", error);
                    });*/
    </script>



    <style>
        /* Estilo adicional */
        /* Defina as variáveis CSS dentro de :root */
        :root {
            --primary-color: #071e2c;
            --secondary-color: #fb9a70 !important;
        }

        body {
            color: var(--primary-color);
            padding: 20px;
        }



        .btn {
            border-radius: 25px;
            padding: 4px 15px;
            margin: 0 4px;
        }

        .bg-success {
            background-color: var(--secondary-color) !important;
        }

        .text-success {
            color: var(--secondary-color) !important;
        }


        .icon-shape {
            display: inline-flex;
            padding: 12px;
            text-align: center;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
        }

        .icon {
            width: 3rem;
            height: 3rem;
        }

        .pago span,
        .pendente span {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .pago span {
            color: var(--secondary-color);
            background-color: #e7e7e7;
            border-radius: 25px;
            padding: 4px 12px;
            /* Cor verde para indicar status "Pago" */
        }

        .pendente span {
            color: #dc3545;
            background-color: #e7e7e7;
            border-radius: 25px;
            padding: 4px 12px;
            /* Cor vermelha para indicar status "Pendente" */
        }

        .saldo-negativo {
            color: #dc3545;
        }


        .offline-message {
            font-size: 0.8em;
            border-radius: 0 0 25px 25px;
            border-bottom: 4px solid var(--secondary-color);
            background-color: var(--primary-color);
            color: #e7e7e7;
            padding: 5px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 9999;
        }


        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9;
            display: flex;
            flex-direction: column;
            /* Inverte a ordem dos itens */
            align-items: flex-end;
        }

        .fab-button {
            opacity: 0.9;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            border-radius: 50%;
            text-align: center;
            font-size: 30px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            /* Adicionamos padding para centralizar o ícone no botão */
            padding: 15px;
            /* Ajustamos a linha de altura para centralizar o texto verticalmente */
            line-height: 30px;


        }



        .fab-button.active {
            transform: rotate(45deg);
            /* Rotação para transformar em "x" */
            /* Rotação para transformar em "x" */
        }

        .fab-options {
            display: none;
            flex-direction: column;
            align-items: flex-end;
            margin-bottom: 10px;
            /* Adiciona espaço abaixo das opções */
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
        }

        .fab-options.active {
            display: flex;
            /* Exibe as opções ao passar o mouse sobre o contêiner */
            opacity: 1;
            transform: translateY(0);
        }

        .fab-option,
        a.fab-option {
            font-weight: bold;
            color: #071e2c;
            text-decoration: none;
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .fab-option:hover {
            background-color: #f0f0f0;
        }

        /*


        .fab-container:hover .fab-button {

            transform: rotate(45deg);
        }

        .fab-container:hover .fab-options {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }*/

        #loadingScreen {
            display: flex;
            top: 0;
            left: 0;
            position: fixed;
            z-index: 999;
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .user-info {
            display: flex;
            justify-content: right;
            padding: 20px 30px;
            border-radius: 8px;
            color: var(--primary-color);
        }

        .user-info a {}

        .skeleton {
            position: relative;
            overflow: hidden;
            /* Garante que o gradiente não vaze */
        }

        /* Animação de carregamento */
        @keyframes loadingAnimation {
            0% {
                background-position: -200px 0;
            }

            100% {
                background-position: calc(100% + 200px) 0;
            }
        }

        .skeleton.loading::after {
            content: "";
            background: linear-gradient(90deg, rgba(240, 240, 240, 1), rgba(250, 250, 250, 1), rgba(240, 240, 240, 1));
            border-radius: 5px;
            display: inline-block;
            width: 100%;
            height: 100%;
            animation: loadingAnimation 3s infinite linear;
            position: absolute;
            left: 0;
            top: 0;
        }
    </style>
</head>

<body>
    <div class="user-info bg-light">
        <span>Olá, <span id="userInfo"></span>! <a href="#" class="text-info" onclick="logout()">Sair</a></span>
    </div>


    <div class="container">
        <div id="offline-message" class="offline-message">
            Você está visualizando a versão offline. Verifique sua conexão.
        </div>



        <div class="fab-container">

            <div class="fab-options">

                <a class="fab-option add" data-toggle="modal" data-target="#modalReceita"><i
                        class="fas fa-plus-circle"></i> Adicionar Receita</a>
                <a class="fab-option add" data-toggle="modal" data-target="#modalDespesa"><i
                        class="fas fa-plus-circle"></i> Adicionar Despesa</a>

                <!-- Opção para exportar os dados -->
                <a class="fab-option import" href="#" onclick="exportarDados()"><i class="fas fa-file-export"></i>
                    Exportar
                    dados</a>

                <!-- Opção para importar os dados -->
                <label class="fab-option export" for="inputImportarDados"><i class="fas fa-upload"></i> Importar dados
                    <input type="file" id="inputImportarDados" accept=".json" onchange="importarDados(event)"
                        style="display: none;">
                </label>

            </div>
            <div class="fab-button bg-info"><i class="fa-solid fa-plus"></i></div>
        </div>

        <div class="row">
            <div class="col">
                <div class="row">
                    <div class="m-auto">
                        <img src="./assets/images/Fincontrol.png" alt="" srcset="" width="150px">
                    </div>

                </div>


            </div>
        </div>
        <div class="logo m-auto d-flex justify-content-center align-items-center">


        </div>
        <h1 class="mt-4 h4 font-weight-bold text-center title">Controle Financeiro</h1>


        <!-- Modais -->
        <!-- Modal para editar receitas -->
        <div class="modal fade" id="modalEditarReceita" tabindex="-1" role="dialog"
            aria-labelledby="modalEditarReceitaLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarReceitaLabel">Editar Receita</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editarReceitaForm">
                            <div class="form-group">
                                <input type="text" class="form-control" id="editNomeReceita" placeholder="Nome">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control date" id="editDataReceita" placeholder="Data">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control  money" id="editValorReceita"
                                    placeholder="Valor">
                            </div>

                            <div class="form-group d-none">
                                <select class="form-control" id="editCategoriaReceita">
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Alimentação">Alimentação</option>
                                    <option value="Transporte">Transporte</option>
                                    <option value="Moradia">Moradia</option>
                                    <option value="Educação">Educação</option>
                                    <option value="Saúde">Saúde</option>
                                    <option value="Lazer">Lazer</option>
                                    <option value="Entretenimento">Entretenimento</option>
                                    <option value="Roupas e acessórios">Roupas e acessórios</option>
                                    <option value="Presentes e doações">Presentes e doações</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select class="form-control" id="editStatusReceita">
                                    <option value="Pendente">Pendente</option>
                                    <option value="Pago">Pago</option>
                                </select>
                            </div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="salvarEdicaoReceita()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para editar despesas -->
        <div class="modal fade" id="modalEditarDespesa" tabindex="-1" role="dialog"
            aria-labelledby="modalEditarDespesaLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarDespesaLabel">Editar Despesa</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editarDespesaForm">
                            <div class="form-group">
                                <input type="text" class="form-control" id="editNomeDespesa" placeholder="Nome">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control date" id="editDataDespesa" placeholder="Data">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control money" id="editValorDespesa" placeholder="Valor">
                            </div>
                            <div class="form-group">
                                <select class="form-control" id="editCategoriaDespesa">
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Alimentação">Alimentação</option>
                                    <option value="Transporte">Transporte</option>
                                    <option value="Moradia">Moradia</option>
                                    <option value="Educação">Educação</option>
                                    <option value="Saúde">Saúde</option>
                                    <option value="Lazer">Lazer</option>
                                    <option value="Entretenimento">Entretenimento</option>
                                    <option value="Roupas e acessórios">Roupas e acessórios</option>
                                    <option value="Presentes e doações">Presentes e doações</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select class="form-control" id="editStatusDespesa">
                                    <option value="Pendente">Pendente</option>
                                    <option value="Pago">Pago</option>
                                </select>
                            </div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="salvarEdicaoDespesa()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para adicionar receitas -->
        <div class="modal fade" id="modalReceita" tabindex="-1" role="dialog" aria-labelledby="modalReceitaLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalReceitaLabel">Adicionar Receita</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="receitaForm">
                            <div class="form-group">
                                <input type="text" class="form-control" id="nomeReceita" placeholder="Nome">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control date" id="dataReceita" placeholder="Data">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control money" id="valorReceita" placeholder="Valor">
                            </div>
                            <div class="form-group d-none">
                                <select class="form-control" id="categoriaReceita">
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Alimentação">Alimentação</option>
                                    <option value="Transporte">Transporte</option>
                                    <option value="Moradia">Moradia</option>
                                    <option value="Educação">Educação</option>
                                    <option value="Saúde">Saúde</option>
                                    <option value="Lazer">Lazer</option>
                                    <option value="Entretenimento">Entretenimento</option>
                                    <option value="Roupas e acessórios">Roupas e acessórios</option>
                                    <option value="Presentes e doações">Presentes e doações</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>

                            <div class="form-group">

                                <select class="form-control" id="statusReceita">
                                    <option value="Pendente">Pendente</option>
                                    <option value="Pago" selected>Pago</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="adicionarReceita()">Adicionar
                            Receita</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para adicionar despesas -->
        <div class="modal fade" id="modalDespesa" tabindex="-1" role="dialog" aria-labelledby="modalDespesaLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalDespesaLabel">Adicionar Despesa</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="despesaForm">
                            <div class="form-group">
                                <input type="text" class="form-control" id="nomeDespesa" placeholder="Nome">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control date" id="dataDespesa" placeholder="Data">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control money" id="valorDespesa" placeholder="Valor">
                            </div>
                            <div class="form-group">
                                <select class="form-control" id="categoriaDespesa">
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Alimentação">Alimentação</option>
                                    <option value="Transporte">Transporte</option>
                                    <option value="Moradia">Moradia</option>
                                    <option value="Educação">Educação</option>
                                    <option value="Saúde">Saúde</option>
                                    <option value="Lazer">Lazer</option>
                                    <option value="Entretenimento">Entretenimento</option>
                                    <option value="Roupas e acessórios">Roupas e acessórios</option>
                                    <option value="Presentes e doações">Presentes e doações</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select class="form-control" id="statusDespesa">
                                    <option value="Pendente">Pendente</option>
                                    <option value="Pago">Pago</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="adicionarDespesa()">Adicionar
                            Despesa</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Dashboard com o total de rendas, despesas e saldo -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card  card-stats  mb-4 mb-xl-0">

                    <div class="card-body">
                        <div class="row">
                            <div class="col">
                                <span class=" font-weight-bold card-title text-uppercase text-muted mb-0">Total de
                                    Receitas</span>
                                <p class="h5  card-text font-weight-bold mb-0 skeleton" id="totalReceitas">R$ 0,00</p>
                            </div>
                            <div class="col-auto">
                                <div class="icon icon-shape bg-info text-white rounded-circle shadow">
                                    <i class="fa-regular fa-dollar-sign"></i>
                                </div>
                            </div>
                        </div>
                        <p class="mt-3 mb-0 text-muted text-sm skeleton" id="legendReceitas">
                            <span class="text-success"><small><i class="fa-solid fa-circle"></i></small></span>
                            <span class="text-success mr-0">3.48%</span>
                            <span class="text-nowrap">Since last month</span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card card-stats  mb-4 mb-xl-0">
                    <div class="card-body">

                        <div class="row">
                            <div class="col">
                                <span class="font-weight-bold card-title text-uppercase text-muted mb-0">Total de
                                    Despesas</span>
                                <p class="h5 font-weight-bold mb-0 skeleton" id="totalDespesas">R$ 0,00</p>
                            </div>
                            <div class="col-auto">
                                <div class="icon icon-shape bg-danger text-white rounded-circle shadow">
                                    <i class="fa-solid fa-arrow-turn-down"></i>
                                </div>
                            </div>
                        </div>
                        <p class="mt-3 mb-0 text-muted text-sm skeleton" id="legendDespesas">
                            <span class="text-success"><small><i class="fa-solid fa-circle"></i></small></span>
                            <span class="text-success mr-0 ">3.48%</span>
                            <span class="text-nowrap ">Since last month</span>
                        </p>
                    </div>
                </div>


            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col">
                                <span class="font-weight-bold card-title text-uppercase text-muted mb-0">Balanço</span>
                                <p class="h5 font-weight-bold mb-0 skeleton" id="saldo">R$ 0,00</p>
                            </div>
                            <div class="col-auto">
                                <div class="icon icon-shape bg-success text-white rounded-circle shadow">
                                    <i class="fa-solid fa-hand-holding-dollar"></i>
                                </div>
                            </div>
                        </div>
                        <p class="mt-3 mb-0 text-muted text-sm skeleton" id="legendSaldo">
                            <span class="text-success"><small><i class="fa-solid fa-circle"></i></small></span>
                            <span class="text-success mr-0 ">3.48%</span>
                            <span class="text-nowrap ">Since last month</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>


        <!-- Exibição dos dados -->
        <div id="dados" class="mt-4">

            <div class="row d-flex mt-5 mb-2">
                <div class="col-md-6 col-sm-12 mb-1 text-center text-md-left">
                    <span class="h5 font-weight-bold">Receitas</span>
                </div>

                <div class="col-md-6 col-sm-12 text-center text-md-right">
                    <button type="button" class="btn btn-sm d-print-none btn-info" data-toggle="modal"
                        data-target="#modalReceita">Adicionar Receita</button>
                </div>

            </div>


            <ul id="listaReceitas" class="p-0"></ul>

            <div class="row d-flex mt-5 mb-2">

                <div class="col-md-6 col-sm-12 mb-1 text-center text-md-left">
                    <span class="h5 font-weight-bold">Despesas</span>
                </div>

                <div class="col-md-6 col-sm-12 text-center text-md-right">
                    <button type="button" class="btn btn-sm d-print-none btn-danger" data-toggle="modal"
                        data-target="#modalDespesa">Adicionar Despesa</button>
                </div>


            </div>

            <ul id="listaDespesas" class="p-0 "></ul>

        </div>





    </div>
    <div class="container-fluid bg-info>
        <div class=" row">
        <div class="col-md-6 offset-md-3 mt-5">
            <h2>Compartilhar Banco de Dados</h2>
            <p>Copie o link abaixo e compartilhe com quem deseja ter acesso ao seu banco de dados:</p>
            <input type="text" class="form-control mb-2" id="shareLink" value="" readonly>
            <button class="btn btn-primary" onclick="copyShareLink()">Gerar e Copiar Link</button>
        </div>
    </div>
    </div>
    <div id="loadingScreen">
        <div class="row">
            <div class="col">
                <div class="row">
                    <div class="m-auto">
                        <img src="./assets/images/Fincontrol.png" alt="" srcset="" width="150px">
                    </div>

                </div>


            </div>
        </div>

    </div>
    <script>


        //let user
        // Verifica se o usuário já está logado
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Chama a função de atualização se o usuário estiver autenticado
                user = user

                atualizarExibicao();
            } else {
                console.error("Usuário não autenticado.");
                // Aqui você pode lidar com a situação de usuário não autenticado, como redirecionar para a página de login
            }
        });

        async function getAccessUid() {
            const user = firebase.auth().currentUser;
            const uid = user.uid;

            // Obter o token da URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                // Procurar o user.uid correspondente na coleção accessTokens
                const tokenDoc = await db.collection("accessTokens").doc(token).get();

                //if (tokenDoc.exists) {
                const userUid = tokenDoc.data().uid;
                console.log(userUid);
                console.log('usuario:' + uid, 'Shared:' + userUid)
                if (uid != userUid) {
                    return userUid;
                }



            } else {
                // Obter o documento do usuário
                const userDoc = await db.collection("users").doc(uid).get();
                const userData = userDoc.data();

                // Se o sharedAccessUid existir, usá-lo. Caso contrário, usar o uid do usuário.
                return (userData && userData.sharedAccessUid) ? userData.sharedAccessUid : uid;
            }
        }


        // Função para adicionar receita
        async function adicionarReceita() {
            const nome = document.getElementById("nomeReceita").value;
            const data = document.getElementById("dataReceita").value;
            const valor = parseFloat(document.getElementById("valorReceita").value.replace('.', '').replace(',', '.'));
            const categoria = document.getElementById("categoriaReceita").value;
            const statusReceita = document.getElementById("statusReceita").value;

            // Verificar se os campos obrigatórios estão preenchidos
            if (nome && data && valor && statusReceita) {
                // Adicionar os dados ao Firestore

                const accessUid = await getAccessUid();

                // Usar o accessUid para acessar o banco de dados
                db.collection("users").doc(accessUid).collection("receitas").add({
                    nome: nome,
                    data: data,
                    valor: valor,
                    categoria: categoria,
                    status: statusReceita

                })
                    .then((docRef) => {
                        console.log("Receita adicionada com ID: ", docRef.id);
                        console.log(docRef.id)
                        // Limpar os campos do formulário e fechar o modal
                        document.getElementById("nomeReceita").value = "";
                        document.getElementById("dataReceita").value = "";
                        document.getElementById("valorReceita").value = "";
                        document.getElementById("categoriaReceita").value = "";
                        document.getElementById("statusReceita").value = "";
                        // Atualizar a exibição
                        atualizarExibicao();
                        // Fechar o modal
                        $('#modalReceita').modal('hide');
                    })
                    .catch((error) => {
                        console.error("Erro ao adicionar receita: ", error);
                    });
            } else {
                alert("Por favor, preencha todos os campos obrigatórios.");
            }
        }

        // Função para adicionar despesa
        async function adicionarDespesa() {
            const nome = document.getElementById("nomeDespesa").value;
            const data = document.getElementById("dataDespesa").value;
            const valor = parseFloat(document.getElementById("valorDespesa").value.replace('.', '').replace(',', '.'));
            const categoria = document.getElementById("categoriaDespesa").value;
            const statusDespesa = document.getElementById("statusDespesa").value;

            // Verificar se os campos obrigatórios estão preenchidos
            if (nome && data && valor && categoria && statusDespesa) {
                // Adicionar os dados ao Firestore
                const accessUid = await getAccessUid();

                // Usar o accessUid para acessar o banco de dados
                db.collection("users").doc(accessUid).collection("despesas").add({
                    nome: nome,
                    data: data,
                    valor: valor,
                    categoria: categoria,
                    status: statusDespesa
                })
                    .then((docRef) => {
                        console.log("Despesa adicionada com ID: ", docRef.id);
                        // Limpar os campos do formulário e fechar o modal
                        document.getElementById("nomeDespesa").value = "";
                        document.getElementById("dataDespesa").value = "";
                        document.getElementById("valorDespesa").value = "";
                        document.getElementById("categoriaDespesa").value = "";
                        document.getElementById("statusDespesa").value = "";
                        // Atualizar a exibição
                        atualizarExibicao();
                        // Fechar o modal
                        $('#modalDespesa').modal('hide');
                    })
                    .catch((error) => {
                        console.error("Erro ao adicionar despesa: ", error);
                    });
            } else {
                alert("Por favor, preencha todos os campos obrigatórios.");
            }
        }

        // Função para exibir os dados e atualizar o dashboard
        // Função para exibir os dados e atualizar o dashboard


        async function atualizarExibicao() {
            // Exibir a tela de carregamento
            document.getElementById('loadingScreen').style.display = 'none';

            // Para exibir o esqueleto de carregamento
            // Para exibir o esqueleto de carregamento
            document.querySelectorAll('.skeleton').forEach(element => {
                element.classList.add('loading');
            });


            const accessUid = await getAccessUid();
            try {
                // Limpar listas
                listaReceitas.innerHTML = '';
                listaDespesas.innerHTML = '';

                // Adicionar listener para receitas
                const receitasQuery = db.collection("users").doc(accessUid).collection("receitas").get();

                // Adicionar listener para despesas
                const despesasQuery = db.collection("users").doc(accessUid).collection("despesas").get();

                // Esperar que ambas as consultas sejam concluídas
                const [receitasSnapshot, despesasSnapshot] = await Promise.all([receitasQuery, despesasQuery]);

                receitasSnapshot.forEach(doc => {
                    try {
                        const receita = doc.data();
                        const id = doc.id;
                        const item = criarItemLista(receita, "Receita", id);
                        listaReceitas.appendChild(item);
                        calcularValores();
                    } catch (error) {
                        console.error(`Erro ao processar a receita com ID ${doc.id}:`, error);
                    }
                });

                despesasSnapshot.forEach(doc => {
                    try {
                        const despesa = doc.data();
                        const id = doc.id;
                        const item = criarItemLista(despesa, "Despesa", id);
                        listaDespesas.appendChild(item);
                        calcularValores();
                    } catch (error) {
                        console.error(`Erro ao processar a despesa com ID ${doc.id}:`, error);
                    }
                });



                // Ocultar a tela de carregamento quando os dados terminarem de carregar

                //document.querySelector('.skeleton').classList.remove('loading');
                // Para ocultar o esqueleto de carregamento quando a operação estiver concluída
                document.querySelectorAll('.skeleton').forEach(element => {
                    element.classList.remove('loading');
                });
            } catch (error) {
                console.error("Erro ao atualizar exibição:", error);
            }
        }
        async function calcularValores() {
            // Calcular e exibir os valores de receitas e despesas em seus respectivos cards
            const totalReceitasPagas = await calcularSomaValoresReceitas("Pago");
            const totalReceitasPendentes = await calcularSomaValoresReceitas("Pendente");

            const totalReceitas = (totalReceitasPagas + totalReceitasPendentes);

            const totalDespesasPagas = await calcularSomaValoresDespesas("Pago");
            const totalDespesasPendentes = await calcularSomaValoresDespesas("Pendente");

            const totalDespesas = (totalDespesasPagas + totalDespesasPendentes);

            const quantidadeDespesasPagas = await calcularQuantidadeDespesas("Pago");
            const quantidadeDespesasPendentes = await calcularQuantidadeDespesas("Pendente");

            // Atualizar os valores nos cards de receitas
            document.getElementById("totalReceitas").textContent = `R$ ${formatarValorParaExibicao(totalReceitas)}`;

            // Atualizar os valores nos cards de despesas
            document.getElementById("totalDespesas").innerText = `R$ ${formatarValorParaExibicao(totalDespesasPagas + totalDespesasPendentes)}`;

            // Calcular saldo
            const saldo = (totalReceitas) - (totalDespesasPagas + totalDespesasPendentes);
            document.getElementById("saldo").textContent = `R$ ${formatarValorParaExibicao(saldo)}`;

            // Verificar se o saldo é negativo e aplicar a classe correspondente
            if (saldo < 0) {
                document.getElementById("saldo").classList.add("saldo-negativo"); // Adiciona a classe "saldo-negativo"
            } else {
                document.getElementById("saldo").classList.remove("saldo-negativo"); // Remove a classe "saldo-negativo"
            }

            // Seleciona o primeiro span dentro do elemento com id "legendDespesas"
            document.querySelector('#legendReceitas span:nth-child(2)').textContent = totalReceitasPendentes ? `R$ ${formatarValorParaExibicao(totalReceitasPendentes)}` : `R$ ${formatarValorParaExibicao(totalReceitas)}`;
            document.querySelector('#legendReceitas span:nth-child(3)').textContent = `${totalReceitasPendentes ? 'pendente' : 'recebido'}`;

            // Atualizar a porcentagem de despesas pagas em relação ao total de despesas no card "legendDespesas"
            const percentualDespesasPagas = ((quantidadeDespesasPagas) / (quantidadeDespesasPagas + quantidadeDespesasPendentes)) * 100;
            if (totalReceitasPagas > 0) {
                document.querySelector('#legendDespesas span:nth-child(2)').textContent = `${percentualDespesasPagas.toFixed(2)}%`;
                document.querySelector('#legendDespesas span:nth-child(3)').textContent = ` das despesas já pagas`;
            } else {
                document.querySelector('#legendDespesas span:nth-child(2)').textContent = `R$ ${formatarValorParaExibicao(0)}`;
                document.querySelector('#legendDespesas span:nth-child(3)').textContent = ` receita`;
            }

            // Calcular a diferença entre o total de receitas pagas e o total de despesas pagas
            const diferencaReceitasDespesas = totalReceitasPagas - totalDespesasPagas;

            // Calcular a porcentagem da diferença em relação ao total de receitas pagas
            const percentualBalanco = (diferencaReceitasDespesas / totalReceitasPagas) * 100;

            // Atualizar a porcentagem de saldo no card "legendSaldo"
            document.querySelector('#legendSaldo span:nth-child(2)').textContent = `${percentualBalanco > 0 ? percentualBalanco.toFixed(2) : '0'}%`;
            document.querySelector('#legendSaldo span:nth-child(3)').textContent = `de saldo (R$ ${formatarValorParaExibicao(diferencaReceitasDespesas)})`;

        }

        function criarItemLista(item, tipo, id) {
            const listItem = document.createElement('li');
            listItem.classList.add('list-group-item');
            // Adicionando o atributo data-id
            listItem.setAttribute('data-id', id);

            const statusClass = item.status === 'Pago' ? 'text-success' : 'text-danger';

            listItem.innerHTML = `
            <div class="row">
                <div class="col">
                    <div class="row">
                        <div class="col-md-3 h5 font-weight-bold mb-0">
                            <div>${item.nome}</div>
                            <div class="${tipo === 'Receita' ? 'text-success' : 'text-danger'}"> R$ ${formatarValorParaExibicao(item.valor)}</div>
                        </div>
                        <div class="m-auto col-md-3 mb-0">
                            <div class="text-md-center">
                                <span class="text-md-center d-md-none">Categoria:</span>
                                <button class="btn btn-sm py-0 px-2 btn-secondary" onclick="${tipo === 'Receita' ? `editarReceita('${id}')` : `editarDespesa('${id}')`}">${item.categoria ? item.categoria : 'Sem categoria'}</button>
                            </div>
                        </div>
                        <div class="m-auto col-md-3 mb-0">
                            <div class="text-md-center">
                                <span class="text-md-center d-md-none">Data:</span>
                                <span>${item.data ? item.data : '<i>Indefinido</i>'}</span>
                            </div>
                        </div>
                        <div class="m-auto col-md-3 mb-0">
                            <div class="text-md-center">
                                <span class="text-md-center d-md-none">Status:</span>
                                <button class="btn ${statusClass} bg-light" onclick="${tipo === 'Receita' ? `editarReceita('${id}')` : `editarDespesa('${id}')`}">${item.status}</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-auto d-flex d-print-none">
                    <div class="mt-2 m-sm-auto ">
                        <button class="btn btn-info btn-sm" onclick="${tipo === 'Receita' ? `editarReceita('${id}')` : `editarDespesa('${id}')`}"">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="${tipo === 'Receita' ? `excluirReceita('${id}')` : `excluirDespesa('${id}')`}">Excluir</button>
                        </div>
                                
                    </div>
                </div>
            </div>
            

    `;

            return listItem;
        }


        // Função para editar receita por ID
        async function editarReceita(id) {

            const accessUid = await getAccessUid();
            // Usar o accessUid para acessar o banco de dados
            db.collection("users").doc(accessUid).collection("receitas").doc(id).get()
                .then((doc) => {
                    if (doc.exists) {
                        const receita = doc.data();
                        // Preencher campos do formulário de edição com os dados da receita a ser editada
                        document.getElementById("editNomeReceita").value = receita.nome;
                        document.getElementById("editDataReceita").value = receita.data;
                        document.getElementById("editValorReceita").value = formatarValorParaExibicao(receita.valor);
                        document.getElementById("editCategoriaReceita").value = receita.categoria;
                        document.getElementById("editStatusReceita").value = receita.status;

                        // Armazenar temporariamente o ID da receita que será editada
                        itemParaEditar = id;
                        tipoItemParaEditar = 'receita';

                        // Abrir modal de edição
                        $('#modalEditarReceita').modal('show');
                    } else {
                        console.error("Documento não encontrado.");
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar receita para edição:", error);
                });
        }

        // Função para editar despesa por ID
        async function editarDespesa(id) {
            const accessUid = await getAccessUid();
            // Usar o accessUid para acessar o banco de dados
            db.collection("users").doc(accessUid).collection("despesas").doc(id).get()
                .then((doc) => {
                    if (doc.exists) {
                        const despesa = doc.data();
                        // Preencher campos do formulário de edição com os dados da despesa a ser editada
                        document.getElementById("editNomeDespesa").value = despesa.nome;
                        document.getElementById("editDataDespesa").value = despesa.data;
                        document.getElementById("editValorDespesa").value = formatarValorParaExibicao(despesa.valor);
                        document.getElementById("editCategoriaDespesa").value = despesa.categoria;
                        document.getElementById("editStatusDespesa").value = despesa.status;

                        // Armazenar temporariamente o ID da despesa que será editada
                        itemParaEditar = id;
                        tipoItemParaEditar = 'despesa';

                        // Abrir modal de edição
                        $('#modalEditarDespesa').modal('show');
                    } else {
                        console.error("Documento não encontrado.");
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar despesa para edição:", error);
                });
        }
        // Função para excluir receita por ID
        async function excluirReceita(id) {
            const accessUid = await getAccessUid();
            // Usar o accessUid para acessar o banco de dados

            Swal.fire({
                title: "Exclusão",
                text: "Deseja exlcuir o item?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sim, remova!"
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection("users").doc(accessUid).collection("receitas").doc(id).delete()
                        .then(() => {
                            Swal.fire({
                                title: "Excluído!",
                                text: "A ação não pode ser desfeita.",
                                icon: "success"
                            });
                            atualizarExibicao();
                        })
                        .catch((error) => {
                            console.error("Erro ao excluir receita:", error);
                        });

                }
            });

        }

        // Função para excluir despesa por ID
        async function excluirDespesa(id) {
            const accessUid = await getAccessUid();
            // Usar o accessUid para acessar o banco de dados

            Swal.fire({
                title: "Exclusão",
                text: "Deseja excluir o item?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sim, exclua!"
            }).then((result) => {
                if (result.isConfirmed) {
                    db.collection("users").doc(accessUid).collection("despesas").doc(id).delete()
                        .then(() => {
                            Swal.fire({
                                title: "Excluído!",
                                text: "A ação não pode ser desfeita.",
                                icon: "success"
                            });
                            atualizarExibicao();
                        })
                        .catch((error) => {
                            console.error("Erro ao excluir despesa:", error);
                        });

                }
            });

        }

        // Função para salvar a edição da receita por ID
        async function salvarEdicaoReceita() {
            if (itemParaEditar && tipoItemParaEditar === 'receita') {
                const nome = document.getElementById("editNomeReceita").value;
                const data = document.getElementById("editDataReceita").value;
                const valor = parseFloat(document.getElementById("editValorReceita").value.replace('.', '').replace(',', '.'));
                const categoria = document.getElementById("editCategoriaReceita").value;
                const statusReceita = document.getElementById("editStatusReceita").value;

                // Atualizar os dados da receita no Firestore
                const accessUid = await getAccessUid();

                // Usar o accessUid para acessar o banco de dados

                db.collection("users").doc(accessUid).collection("receitas").doc(itemParaEditar).update({ nome, data, valor, categoria, status: statusReceita })
                    .then(() => {
                        toast.show('Atualizar', 'Item atualizado com sucesso!')
                        $('#modalEditarReceita').modal('hide');
                        atualizarExibicao();
                    })
                    .catch((error) => {
                        console.error("Erro ao atualizar despesa:", error);
                    });


            }
        }

        // Função para salvar a edição da despesa por ID
        async function salvarEdicaoDespesa() {
            if (itemParaEditar && tipoItemParaEditar === 'despesa') {
                const nome = document.getElementById("editNomeDespesa").value;
                const data = document.getElementById("editDataDespesa").value;
                const valor = parseFloat(document.getElementById("editValorDespesa").value.replace('.', '').replace(',', '.'));
                const categoria = document.getElementById("editCategoriaDespesa").value;
                const statusDespesa = document.getElementById("editStatusDespesa").value;

                // Atualizar os dados da despesa no Firestore
                const accessUid = await getAccessUid();

                // Usar o accessUid para acessar o banco de dados
                db.collection("users").doc(accessUid).collection("despesas").doc(itemParaEditar).update({ nome, data, valor, categoria, status: statusDespesa })
                    .then(() => {
                        toast.show('Atualizar', 'Item atualizado com sucesso!')
                        // Atualizar a exibição
                        atualizarExibicao();
                        // Fechar modal de edição
                        $('#modalEditarDespesa').modal('hide');
                    })
                    .catch((error) => {
                        console.error("Erro ao atzualizar despesa:", error);
                    });
            }
        }


        // Função para calcular a soma dos valores de receitas com base no status
        async function calcularSomaValoresReceitas(status) {
            const accessUid = await getAccessUid();

            try {
                let total = 0;
                // Usar o accessUid para acessar o banco de dados
                const receitasSnapshot = await db.collection("users").doc(accessUid).collection("receitas").where("status", "==", status).get();
                receitasSnapshot.forEach((doc) => {
                    const receita = doc.data();
                    total += receita.valor;
                });
                return total;
            } catch (error) {
                console.error("Erro ao calcular a soma dos valores de receitas:", error);
                return 0;
            }
        }

        // Função para calcular a soma dos valores de despesas com base no status
        async function calcularSomaValoresDespesas(status) {
            const accessUid = await getAccessUid();

            try {
                let total = 0;
                // Usar o accessUid para acessar o banco de dados
                const despesasSnapshot = await db.collection("users").doc(accessUid).collection("despesas").where("status", "==", status).get();
                despesasSnapshot.forEach((doc) => {
                    const despesa = doc.data();
                    total += despesa.valor;
                });
                return total;
            } catch (error) {
                console.error("Erro ao calcular a soma dos valores de despesas:", error);
                return 0;
            }
        }

        // Função para calcular a quantidade de despesas com base no status
        async function calcularQuantidadeDespesas(status) {
            const accessUid = await getAccessUid();
            // Usar o accessUid para acessar o banco de dados
            try {
                let quantidade = 0;
                const despesasSnapshot = await db.collection("users").doc(accessUid).collection("despesas").where("status", "==", status).get();
                quantidade = despesasSnapshot.size;
                return quantidade;
            } catch (error) {
                console.error("Erro ao calcular a quantidade de despesas:", error);
                return 0;
            }
        }

        // Função para formatar o valor para exibição
        function formatarValorParaExibicao(valor) {
            // Verifica se o valor é um número
            if (typeof valor !== 'number' || isNaN(valor)) {
                return ''; // Retorna uma string vazia se o valor não for um número válido
            }

            // Converte o valor para uma string com duas casas decimais e separador de milhares
            const valorFormatado = valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Remove o símbolo de moeda (R$) e espaços em branco do valor formatado
            return valorFormatado.replace('R$', '').trim();
        }



        // Exemplo de uso da biblioteca
        function exportarDados() {
            const dados = {
                receitas: JSON.parse(localStorage.getItem('receitas')) || [],
                despesas: JSON.parse(localStorage.getItem('despesas')) || []
            };

            const json = JSON.stringify(dados);
            const blob = new Blob([json], { type: 'application/json' });
            const uuid = uuidv4();
            const nomeArquivo = `fincontrol_${uuid}_Export.json`;

            saveAs(blob, nomeArquivo);

            toast.show('Export', nomeArquivo + ' foi exportado')
        }

        // Função para importar os dados de um arquivo JSON
        function importarDados(event) {
            const arquivo = event.target.files[0];
            const leitor = new FileReader();

            leitor.onload = async function (evento) {
                const dados = JSON.parse(evento.target.result);
                const dataAtualizacao = new Date();

                // Formato de data dd/mm/yyyy
                const dia = String(dataAtualizacao.getDate()).padStart(2, '0');
                const mes = String(dataAtualizacao.getMonth() + 1).padStart(2, '0'); // +1 porque os meses são indexados a partir de 0
                const ano = dataAtualizacao.getFullYear();
                const dataFormatada = `${dia}/${mes}/${ano}`;

                // Atualizar todas as datas para a data formatada de importação
                dados.receitas.forEach(receita => receita.data = dataFormatada);
                dados.despesas.forEach(despesa => despesa.data = dataFormatada);

                // Adicionar os dados ao Firestore
                const accessUid = await getAccessUid();

                // Usar o accessUid para acessar o banco de dados
                const receitasRef = db.collection("users").doc(accessUid).collection("receitas");
                const despesasRef = db.collection("users").doc(accessUid).collection("despesas");

                dados.receitas.forEach(receita => {
                    receitasRef.add(receita)
                        .then((docRef) => {
                            console.log("Receita importada com ID: ", docRef.id);
                        })
                        .catch((error) => {
                            console.error("Erro ao importar receita: ", error);
                        });
                });

                dados.despesas.forEach(despesa => {
                    despesasRef.add(despesa)
                        .then((docRef) => {
                            console.log("Despesa importada com ID: ", docRef.id);
                        })
                        .catch((error) => {
                            console.error("Erro ao importar despesa: ", error);
                        });
                });

                // Atualizar a exibição
                atualizarExibicao();
            };

            leitor.readAsText(arquivo);
            toast.show('import', ' Dados importados')
        }

        // Função para gerar um UUID (Universally Unique Identifier)
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }




    </script>

    <script>
        $(function () {

            $('.date').mask('00/00/0000');
            // Seletor do campo de data
            $(".date").datepicker({
                dateFormat: 'dd/mm/yy' // Formato da data
            });

        });

        $(document).ready(function () {
            $('.money').mask("#.##0,00", { reverse: true });
        });


    </script>
    <script>

        // Verificar status da conexão e exibir mensagem offline ao carregar a página
        // Função para definir a cor do tema com base no status da conexão
        function setThemeColorBasedOnConnectionStatus() {
            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            const statusBariOS = document.querySelector('meta[name="apple-mobile-web-app-status-bar"]');

            const isOnline = navigator.onLine;
            const offlineMessage = document.getElementById("offline-message");

            // Define a cor do tema com base no status da conexão
            if (isOnline) {
                themeColorMeta.setAttribute('content', '#FFFFFF'); // Cor do tema quando online
                statusBariOS.setAttribute('content', '#FFFFFF'); // Cor do tema quando online
                offlineMessage.style.display = "none"; // Oculta a mensagem offline
            } else {
                themeColorMeta.setAttribute('content', '#071e2c'); // Cor do tema quando offline
                statusBariOS.setAttribute('content', '#071e2c'); // Cor do tema quando offline
                offlineMessage.style.display = "block"; // Exibe a mensagem offline
            }
        }

        // Verifica o status da conexão ao carregar a página
        document.addEventListener("DOMContentLoaded", () => {
            // Define a cor do tema com base no status da conexão ao carregar a página
            setThemeColorBasedOnConnectionStatus();
        });

        // Monitora alterações no status da conexão
        window.addEventListener('online', setThemeColorBasedOnConnectionStatus);
        window.addEventListener('offline', setThemeColorBasedOnConnectionStatus);


        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        //console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.error('Falha ao registrar o Service Worker:', error);
                    });
            });
        }
    </script>

    <script>
        feather.replace();
    </script>

    <script>



        document.querySelector('.fab-button').addEventListener('click', function () {
            var button = document.querySelector('.fab-button');
            var options = document.querySelector('.fab-options');

            button.classList.toggle('active');
            options.classList.toggle('active');
            // Exemplo de uso

        });

    </script>

    <script>


        // Verifica se está autenticado e Exibe o nome do usuario
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {

                // O usuário está autenticado, exiba o nome
                document.getElementById("userInfo").textContent = user.displayName ? user.displayName : 'Usuário';

            } else {
                // O usuário não está autenticado, redirecione-o para a tela de login
                // Obter o token da URL
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');

                const redrectLogin = token ? `login.html?token=${token}` : `login.html?token=${token}`
                window.location.href = redrectLogin;
            }
        });

        // Função para fazer logout
        function logout() {
            firebase.auth().signOut().then(function () {
                // Logout bem-sucedido, redirecione para a tela de login
                window.location.href = "login.html";
            }).catch(function (error) {
                // Trate erros de logout, se necessário
                console.error("Erro ao fazer logout:", error);
            });
        }

    </script>

    <script>
        // Função para gerar o link de compartilhamento com o token
        async function generateShareLink() {
            try {

                const user = firebase.auth().currentUser;


                // Cria um novo token de convidado no Firestore
                const tokenRef = await db.collection("accessTokens").add({
                    uid: user.uid
                });

                // URL base da sua aplicação (index.html)
                const baseUrl = window.location.href.split('?')[0]; // Remove parâmetros de consulta, se houver

                // Link de compartilhamento com o token como parâmetro de consulta
                const shareLink = `${baseUrl}?token=${tokenRef.id}`;

                return shareLink;
            } catch (error) {
                console.error("Erro ao gerar link de compartilhamento:", error);
                alert("Erro ao gerar link de compartilhamento.");
                return null;
            }
        }


        // Função para copiar o link de compartilhamento
        async function copyShareLink() {
            const shareLink = await generateShareLink();
            const shareLinkInput = document.getElementById("shareLink");
            shareLinkInput.value = shareLink;

            //const shareLinkInput = document.getElementById("shareLink");
            shareLinkInput.select();
            document.execCommand("copy");

            toast.show('Compartilhar', "Link copiado para a área de transferência!");
        }

        // Executar a função de geração do link de compartilhamento ao carregar a página
        window.onload = async function () {
            //const shareLink = await generateShareLink();
            //const shareLinkInput = document.getElementById("shareLink");
            //shareLinkInput.value = shareLink;
        };
    </script>


    <!-- Integração do jQuery e do Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>